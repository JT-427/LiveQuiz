<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»å‹•ç®¡ç† - {{ activity_id }}</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { color: #333; }
        .back-btn {
            padding: 10px 20px;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .back-btn:hover { opacity: 0.9; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: bold; }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        textarea { min-height: 100px; resize: vertical; }
        button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { opacity: 0.9; }
        button.danger { background: #e74c3c; }
        button.success { background: #27ae60; }
        
        .section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section h2 { margin-bottom: 20px; color: #333; }
        .section h3 { margin-bottom: 15px; color: #555; }
        
        .answers-section {
            margin-top: 20px;
        }
        .filter-controls {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-controls label {
            font-weight: bold;
            margin-right: 10px;
            color: #555;
        }
        .filter-controls input[type="text"] {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            min-width: 250px;
            transition: border-color 0.3s;
        }
        .filter-controls input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        .filter-controls .search-icon {
            position: relative;
        }
        .filter-controls .search-icon::before {
            content: 'ğŸ”';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }
        .filter-controls .clear-btn {
            padding: 8px 16px;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .filter-controls .clear-btn:hover {
            background: #7f8c8d;
        }
        .answers-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .answers-table thead {
            background: #667eea;
            color: white;
        }
        .answers-table th {
            padding: 15px;
            text-align: left;
            font-weight: bold;
            position: relative;
        }
        .answers-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            color: #333;
        }
        .answers-table tbody tr:hover {
            background: #f8f9fa;
        }
        .answers-table tbody tr:last-child td {
            border-bottom: none;
        }
        .user-name-cell {
            font-weight: bold;
            color: #667eea;
            position: sticky;
            left: 0;
            background: white;
            z-index: 1;
            min-width: 150px;
        }
        .answers-table tbody tr:hover .user-name-cell {
            background: #f8f9fa;
        }
        .answer-cell {
            max-width: 300px;
            word-wrap: break-word;
            color: #555;
            position: relative;
        }
        .no-answer {
            color: #999;
            font-style: italic;
        }
        .answer-main {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }
        .answer-text-content {
            flex: 1;
            word-wrap: break-word;
        }
        .expand-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            transition: background 0.2s;
        }
        .expand-btn:hover {
            background: #5568d3;
        }
        .answer-list {
            margin-top: 8px;
            padding-left: 15px;
            border-left: 2px solid #ddd;
        }
        .answer-item-history {
            padding: 8px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #667eea;
        }
        .answer-item-time {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
        }
        .answer-count-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
        }
        .project-btn {
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
            transition: background 0.2s;
            margin-right: 8px;
        }
        .project-btn:hover {
            background: #229954;
        }
        .answer-item-with-btn {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        .answer-item-history {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        
        .groups-input {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .group-item {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .group-item input {
            flex: 1;
        }
        .group-item button {
            padding: 8px 16px;
            background: #e74c3c;
        }
        .add-group-btn {
            background: #27ae60;
            padding: 10px 20px;
            margin-top: 10px;
        }
        
        .questions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .question-card {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .question-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }
        .question-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }
        .question-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        .question-card-content {
            font-size: 16px;
            line-height: 1.5;
            color: #333;
            margin-bottom: 12px;
            min-height: 60px;
            word-wrap: break-word;
        }
        .question-card-meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        .question-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #eee;
        }
        .question-card-actions button {
            flex: 1;
            padding: 6px 12px;
            font-size: 12px;
        }
        .question-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-right: 8px;
        }
        .question-type-short_answer {
            background: #e3f2fd;
            color: #1976d2;
        }
        .question-type-multiple_choice {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        .question-type-multiple_select {
            background: #fff3e0;
            color: #e65100;
        }
        .question-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .question-modal.active {
            display: flex;
        }
        .question-modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .question-modal-content h3 {
            margin-bottom: 20px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="activityName">æ´»å‹•ç®¡ç†</h1>
            <a href="/admin" class="back-btn">â† è¿”å›</a>
        </div>
        
        <div id="activityDetails"></div>
    </div>
    
    <!-- é¡Œç›®ç·¨è¼¯/æ–°å¢æ¨¡æ…‹æ¡† -->
    <div id="questionModal" class="question-modal">
        <div class="question-modal-content">
            <h3 id="questionModalTitle">æ–°å¢é¡Œç›®</h3>
            <form id="questionForm" onsubmit="saveQuestion(event)">
                <div class="form-group">
                    <label>é¡Œå‹</label>
                    <select id="modalQuestionType" required onchange="toggleOptionsField()">
                        <option value="short_answer">ç°¡ç­”é¡Œ</option>
                        <option value="multiple_choice">é¸æ“‡é¡Œ</option>
                        <option value="multiple_select">å¤šé¸é¡Œ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é¡Œç›®å…§å®¹</label>
                    <textarea id="modalQuestionContent" required min-height="100px" style="min-height: 100px;"></textarea>
                </div>
                <div class="form-group" id="modalOptionsGroup" style="display: none;">
                    <label>é¸é …ï¼ˆæ¯è¡Œä¸€å€‹ï¼‰</label>
                    <textarea id="modalQuestionOptions" placeholder="é¸é …1&#10;é¸é …2&#10;é¸é …3"></textarea>
                </div>
                <div class="form-group">
                    <label>æ™‚é–“é™åˆ¶ï¼ˆç§’ï¼‰</label>
                    <input type="number" id="modalTimeLimit" value="60" min="1" required>
                </div>
                <div class="form-group">
                    <label>å›ç­”æ¬¡æ•¸é™åˆ¶ï¼ˆç•™ç©ºç‚ºç„¡é™åˆ¶ï¼‰</label>
                    <input type="number" id="modalAnswerLimit" min="1" placeholder="ç•™ç©ºç‚ºç„¡é™åˆ¶">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="success">å„²å­˜</button>
                    <button type="button" onclick="closeQuestionModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const socket = io();
        const activityId = {{ activity_id }};
        let timerInterval = null;
        let timeRemaining = 0;
        let currentQuestion = null;
        
        let currentActivity = null;
        
        function loadActivity() {
            fetch(`/api/activities/${activityId}`)
                .then(res => res.json())
                .then(activity => {
                    currentActivity = activity;
                    document.getElementById('activityName').textContent = activity.name;
                    const details = document.getElementById('activityDetails');
                    
                    // è§£æå°çµ„è¨­å®š
                    let groups = [];
                    if (activity.groups) {
                        try {
                            groups = typeof activity.groups === 'string' ? JSON.parse(activity.groups) : activity.groups;
                        } catch(e) {
                            groups = [];
                        }
                    }
                    if (groups.length === 0 && activity.groups_count) {
                        groups = Array.from({length: activity.groups_count}, (_, i) => `ç¬¬${i+1}çµ„`);
                    }
                    
                    let groupsHtml = '';
                    groups.forEach((group, index) => {
                        groupsHtml += `
                            <div class="group-item">
                                <input type="text" value="${group}" data-index="${index}" placeholder="å°çµ„åç¨±">
                                <button onclick="removeGroup(${index})">åˆªé™¤</button>
                            </div>
                        `;
                    });
                    
                    let html = `
                        <div class="section">
                            <h2>æ´»å‹•è¨­å®š</h2>
                            <div class="form-group">
                                <label>å°çµ„è¨­å®š</label>
                                <div class="groups-input" id="groupsInput">
                                    ${groupsHtml || '<p style="color: #999;">ç›®å‰æ²’æœ‰è¨­å®šå°çµ„</p>'}
                                </div>
                                <button class="add-group-btn" onclick="addGroup()">æ–°å¢å°çµ„</button>
                                <button onclick="saveGroups()" style="margin-top: 10px;">å„²å­˜å°çµ„è¨­å®š</button>
                            </div>
                        </div>
                        
                        <div class="section">
                            <h2>ğŸ“º æŠ•å½±ç•«é¢æ§åˆ¶</h2>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                <button class="success" onclick="showDisplay('qrcode')" style="padding: 15px;">
                                    ğŸ“± é¡¯ç¤º QR Code
                                </button>
                                <button class="success" onclick="showStatsHorizontalWithLimit()" style="padding: 15px;">
                                    ğŸ“Š çµ±è¨ˆæ•¸æ“šï¼ˆæ©«å¼é•·æ¢åœ–ï¼‰
                                </button>
                                <button class="success" onclick="showDisplay('stats_vertical')" style="padding: 15px;">
                                    ğŸ“Š çµ±è¨ˆæ•¸æ“šï¼ˆç›´å¼é•·æ¢åœ–ï¼‰
                                </button>
                                <button class="success" onclick="showDisplay('question')" style="padding: 15px;">
                                    â“ é¡¯ç¤ºé¡Œç›®
                                </button>
                                <button class="success" onclick="showDisplay('participants')" style="padding: 15px;">
                                    ğŸ‘¥ é¡¯ç¤ºåƒèˆ‡åå–®
                                </button>
                                <button onclick="showDisplay('none')" style="padding: 15px; background: #95a5a6;">
                                    â¬› é—œé–‰é¡¯ç¤º
                                </button>
                            </div>
                        </div>
                        
                        <div class="section">
                            <h2>åƒèˆ‡è€…ç®¡ç†</h2>
                            <div id="participantsList" style="margin-top: 15px;">
                                <div style="text-align: center; color: #999; padding: 20px;">
                                    è¼‰å…¥ä¸­...
                                </div>
                            </div>
                        </div>
                        
                        <div class="section">
                            <h2>æ¶ç­”æ§åˆ¶</h2>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <label>é¸æ“‡é¡Œç›®</label>
                                <button class="success" onclick="openQuestionModal()" style="padding: 8px 16px; font-size: 14px;">
                                    â• æ–°å¢é¡Œç›®
                                </button>
                            </div>
                            <div id="questionsGrid" class="questions-grid">
                                <div style="grid-column: 1 / -1; text-align: center; color: #999; padding: 40px;">
                                    è¼‰å…¥é¡Œç›®ä¸­...
                                </div>
                            </div>
                            <div id="questionInfo" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>ç•¶å‰é¡Œç›®ï¼š</strong><span id="currentQuestionName"></span><br>
                                        <small>æ™‚é–“é™åˆ¶ï¼š<span id="currentQuestionTime"></span> ç§’</small>
                                        <br><small id="answerLimitInfo"></small>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 48px; font-weight: bold; color: #667eea;" id="timerDisplay">--:--</div>
                                    </div>
                                </div>
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                                    <button class="success" onclick="restoreDisplay()" style="width: 100%; padding: 10px; font-size: 14px;">
                                        ğŸ“º æ¢å¾©æŠ•å½±ç•«é¢é¡¯ç¤º
                                    </button>
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button class="success" onclick="startActivity()">é–‹å§‹æ¶ç­”</button>
                                <button class="danger" onclick="endActivity()">çµæŸæ¶ç­”</button>
                            </div>
                        </div>
                        
                        <div class="section">
                            <h2>å›ç­”ç´€éŒ„</h2>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <div class="filter-controls" style="margin: 0; flex: 1;">
                                    <label>æœå°‹ç”¨æˆ¶ï¼š</label>
                                    <div class="search-icon" style="position: relative;">
                                        <input type="text" id="userFilter" placeholder="è¼¸å…¥ç”¨æˆ¶åç¨±æˆ–å°çµ„åç¨±æœå°‹..." 
                                               oninput="filterAnswersTable()" 
                                               style="padding-right: 40px;">
                                    </div>
                                    <button class="clear-btn" onclick="clearUserFilter()">æ¸…é™¤</button>
                                </div>
                                <button class="success" onclick="exportToCSV()" style="margin-left: 20px; padding: 10px 20px;">
                                    ğŸ“¥ åŒ¯å‡º CSV
                                </button>
                            </div>
                            <div class="answers-section">
                                <div style="overflow-x: auto;">
                                    <table class="answers-table" id="answersTable">
                                        <thead>
                                            <tr id="tableHeader">
                                                <th>ç”¨æˆ¶åç¨±</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tableBody">
                                            <tr>
                                                <td colspan="100%" style="text-align: center; padding: 30px; color: #999;">
                                                    è¼‰å…¥ä¸­...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    details.innerHTML = html;
                    
                    // è¼‰å…¥åƒèˆ‡è€…åˆ—è¡¨
                    loadParticipants();
                    
                    // è¼‰å…¥é¡Œç›®å¡ç‰‡
                    // ç¢ºä¿ DOM å…ƒç´ å·²å‰µå»ºå¾Œå†è¼‰å…¥
                    setTimeout(() => {
                        const grid = document.getElementById('questionsGrid');
                        if (grid) {
                            loadQuestionsCards(activity.current_question_id);
                        } else {
                            console.error('questionsGrid å…ƒç´ å°šæœªå‰µå»º');
                        }
                    }, 50);
                    
                    // è¼‰å…¥é¡Œç›®ä¸¦æ§‹å»ºè¡¨æ ¼
                    fetch('/api/questions')
                        .then(res => res.json())
                        .then(questions => {
                            buildAnswersTable(activity, questions);
                        });
                });
        }
        
        function addGroup() {
            const container = document.getElementById('groupsInput');
            if (container.querySelector('p')) {
                container.innerHTML = '';
            }
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'group-item';
            div.innerHTML = `
                <input type="text" placeholder="å°çµ„åç¨±" data-index="${index}">
                <button onclick="removeGroup(${index})">åˆªé™¤</button>
            `;
            container.appendChild(div);
        }
        
        function removeGroup(index) {
            const container = document.getElementById('groupsInput');
            const items = Array.from(container.children);
            items.forEach((item, i) => {
                if (parseInt(item.querySelector('input').dataset.index) === index) {
                    item.remove();
                }
            });
            if (container.children.length === 0) {
                container.innerHTML = '<p style="color: #999;">ç›®å‰æ²’æœ‰è¨­å®šå°çµ„</p>';
            }
        }
        
        function saveGroups() {
            const container = document.getElementById('groupsInput');
            const inputs = container.querySelectorAll('input');
            const groups = Array.from(inputs)
                .map(input => input.value.trim())
                .filter(name => name !== '');
            
            fetch(`/api/activities/${activityId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ groups: groups })
            })
            .then(() => {
                alert('å°çµ„è¨­å®šå·²å„²å­˜');
                loadActivity();
            });
        }
        
        function showDisplay(mode, limit = null) {
            const body = { display_mode: mode };
            if (limit !== null) {
                body.stats_limit = limit;
            }
            fetch(`/api/activities/${activityId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            })
            .then(() => {
                console.log('æŠ•å½±ç•«é¢å·²åˆ‡æ›ç‚º:', mode, limit ? `(é™åˆ¶${limit}ç­†)` : '');
                // ä¸å†å½ˆå‡ºç¢ºèªè¨Šæ¯ï¼Œéœé»˜åŸ·è¡Œ
            })
            .catch(err => {
                console.error('åˆ‡æ›æŠ•å½±ç•«é¢å¤±æ•—:', err);
            });
        }
        
        // é¡¯ç¤ºçµ±è¨ˆæ•¸æ“šï¼ˆæ©«å¼é•·æ¢åœ–ï¼‰ä¸¦é¸æ“‡é¡¯ç¤ºç­†æ•¸
        function showStatsHorizontalWithLimit() {
            const limitInput = prompt('è«‹è¼¸å…¥è¦é¡¯ç¤ºçš„ç­†æ•¸ï¼ˆç•™ç©ºæˆ–è¼¸å…¥0è¡¨ç¤ºé¡¯ç¤ºå…¨éƒ¨ï¼‰ï¼š');
            
            if (limitInput === null) {
                // ç”¨æˆ¶å–æ¶ˆ
                return;
            }
            
            let limit = null;
            if (limitInput.trim() !== '') {
                const num = parseInt(limitInput.trim());
                if (!isNaN(num) && num > 0) {
                    limit = num;
                }
            }
            
            // å‚³é limit åƒæ•¸ï¼Œå¦‚æœæ˜¯ null å‰‡é¡¯ç¤ºå…¨éƒ¨
            showDisplay('stats_horizontal', limit);
        }
        
        // æ¢å¾©æŠ•å½±ç•«é¢é¡¯ç¤ºï¼ˆåœ¨æ¶ç­”é€²è¡Œä¸­æ™‚ï¼‰
        function restoreDisplay() {
            if (!currentActivity || currentActivity.status !== 'active') {
                alert('ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„æ¶ç­”');
                return;
            }
            
            if (!currentActivity.current_question_id) {
                alert('è«‹å…ˆé¸æ“‡é¡Œç›®');
                return;
            }
            
            // è¨­ç½®é¡¯ç¤ºæ¨¡å¼ç‚º questionï¼Œä¸¦ç¢ºä¿é¡Œç›®æ­£ç¢ºé¡¯ç¤º
            fetch(`/api/activities/${activityId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    display_mode: 'question',
                    current_question_id: currentActivity.current_question_id
                })
            })
            .then(() => {
                console.log('æŠ•å½±ç•«é¢å·²æ¢å¾©ç‚ºé¡Œç›®é¡¯ç¤ºæ¨¡å¼');
                // ä¸éœ€è¦å½ˆå‡ºæç¤ºï¼Œéœé»˜åŸ·è¡Œ
            })
            .catch(err => {
                console.error('æ¢å¾©æŠ•å½±ç•«é¢å¤±æ•—:', err);
                alert('æ¢å¾©æŠ•å½±ç•«é¢å¤±æ•—ï¼Œè«‹é‡è©¦');
            });
        }
        
        let allQuestionsList = [];
        let editingQuestionId = null;
        
        // è¼‰å…¥é¡Œç›®å¡ç‰‡
        function loadQuestionsCards(selectedQuestionId = null) {
            console.log('è¼‰å…¥é¡Œç›®å¡ç‰‡, selectedQuestionId:', selectedQuestionId);
            const grid = document.getElementById('questionsGrid');
            if (!grid) {
                console.error('questionsGrid å…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            fetch('/api/questions')
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    return res.json();
                })
                .then(questions => {
                    console.log('è¼‰å…¥çš„é¡Œç›®æ•¸é‡:', questions.length);
                    allQuestionsList = questions;
                    grid.innerHTML = '';
                    
                    if (questions.length === 0) {
                        grid.innerHTML = `
                            <div style="grid-column: 1 / -1; text-align: center; color: #999; padding: 40px;">
                                ç›®å‰æ²’æœ‰é¡Œç›®ï¼Œè«‹é»æ“Šã€Œæ–°å¢é¡Œç›®ã€æŒ‰éˆ•æ–°å¢é¡Œç›®
                            </div>
                        `;
                        return;
                    }
                    
                    questions.forEach(q => {
                        const isSelected = selectedQuestionId && parseInt(q.id) === parseInt(selectedQuestionId);
                        const card = createQuestionCard(q, isSelected);
                        grid.appendChild(card);
                    });
                    
                    // å¦‚æœæœ‰é¸ä¸­çš„é¡Œç›®ï¼Œè¼‰å…¥å…¶ä¿¡æ¯
                    if (selectedQuestionId) {
                        const question = questions.find(q => parseInt(q.id) === parseInt(selectedQuestionId));
                        if (question) {
                            loadCurrentQuestionInfo(selectedQuestionId, questions);
                        } else {
                            console.warn('æ‰¾ä¸åˆ°é¸ä¸­çš„é¡Œç›® ID:', selectedQuestionId);
                        }
                    }
                })
                .catch(err => {
                    console.error('è¼‰å…¥é¡Œç›®å¤±æ•—:', err);
                    const grid = document.getElementById('questionsGrid');
                    if (grid) {
                        grid.innerHTML = `
                            <div style="grid-column: 1 / -1; text-align: center; color: #e74c3c; padding: 40px;">
                                è¼‰å…¥é¡Œç›®å¤±æ•—ï¼Œè«‹é‡è©¦<br>
                                <small>éŒ¯èª¤: ${err.message}</small>
                            </div>
                        `;
                    }
                });
        }
        
        // å‰µå»ºé¡Œç›®å¡ç‰‡
        function createQuestionCard(question, isSelected = false) {
            const card = document.createElement('div');
            card.className = `question-card ${isSelected ? 'selected' : ''}`;
            card.dataset.questionId = question.id;
            
            // æ·»åŠ é»æ“Šäº‹ä»¶ï¼ˆé»æ“Šå¡ç‰‡ä¹Ÿå¯ä»¥é¸æ“‡ï¼‰
            card.addEventListener('click', function(e) {
                // å¦‚æœé»æ“Šçš„æ˜¯æŒ‰éˆ•æˆ–å…¶å­å…ƒç´ ï¼Œä¸è§¸ç™¼å¡ç‰‡é¸æ“‡
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    return;
                }
                selectQuestion(question.id);
            });
            
            const typeNames = {
                'short_answer': 'ç°¡ç­”é¡Œ',
                'multiple_choice': 'é¸æ“‡é¡Œ',
                'multiple_select': 'å¤šé¸é¡Œ'
            };
            
            const typeBadgeClass = `question-type-${question.type}`;
            
            card.innerHTML = `
                <div class="question-card-header">
                    <span class="question-type-badge ${typeBadgeClass}">${typeNames[question.type] || question.type}</span>
                </div>
                <div class="question-card-content">${question.content}</div>
                <div class="question-card-meta">
                    â±ï¸ ${question.time_limit || 60} ç§’
                    ${question.answer_limit ? ` | ğŸ“ ${question.answer_limit} æ¬¡é™åˆ¶` : ' | ğŸ“ ç„¡é™åˆ¶'}
                </div>
                <div class="question-card-actions">
                    <button class="success" onclick="event.stopPropagation(); selectQuestion(${question.id})">é¸æ“‡</button>
                    <button onclick="event.stopPropagation(); editQuestion(${question.id})">ç·¨è¼¯</button>
                    <button class="danger" onclick="event.stopPropagation(); deleteQuestion(${question.id})">åˆªé™¤</button>
                </div>
            `;
            
            return card;
        }
        
        // é¸æ“‡é¡Œç›®
        function selectQuestion(questionId) {
            console.log('é¸æ“‡é¡Œç›®:', questionId);
            
            // æ›´æ–°æ´»å‹•çš„ç•¶å‰é¡Œç›®
            updateActivityQuestion(questionId);
            
            // æ›´æ–°å¡ç‰‡é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.question-card').forEach(card => {
                card.classList.remove('selected');
                if (parseInt(card.dataset.questionId) === parseInt(questionId)) {
                    card.classList.add('selected');
                }
            });
            
            // è¼‰å…¥é¡Œç›®ä¿¡æ¯
            if (allQuestionsList && allQuestionsList.length > 0) {
                loadCurrentQuestionInfo(questionId, allQuestionsList);
            } else {
                // å¦‚æœé¡Œç›®åˆ—è¡¨é‚„æ²’è¼‰å…¥ï¼Œå…ˆè¼‰å…¥é¡Œç›®
                fetch('/api/questions')
                    .then(res => res.json())
                    .then(questions => {
                        allQuestionsList = questions;
                        loadCurrentQuestionInfo(questionId, questions);
                    });
            }
        }
        
        // ç·¨è¼¯é¡Œç›®
        function editQuestion(questionId) {
            const question = allQuestionsList.find(q => q.id === questionId);
            if (!question) return;
            
            editingQuestionId = questionId;
            document.getElementById('questionModalTitle').textContent = 'ç·¨è¼¯é¡Œç›®';
            document.getElementById('modalQuestionType').value = question.type;
            document.getElementById('modalQuestionContent').value = question.content;
            document.getElementById('modalTimeLimit').value = question.time_limit || 60;
            document.getElementById('modalAnswerLimit').value = question.answer_limit || '';
            
            // è™•ç†é¸é …
            if (question.options && typeof question.options === 'string') {
                try {
                    const options = JSON.parse(question.options);
                    document.getElementById('modalQuestionOptions').value = options.join('\n');
                } catch(e) {
                    document.getElementById('modalQuestionOptions').value = '';
                }
            } else if (Array.isArray(question.options)) {
                document.getElementById('modalQuestionOptions').value = question.options.join('\n');
            } else {
                document.getElementById('modalQuestionOptions').value = '';
            }
            
            toggleOptionsField();
            document.getElementById('questionModal').classList.add('active');
        }
        
        // æ‰“é–‹æ–°å¢é¡Œç›®æ¨¡æ…‹æ¡†
        function openQuestionModal() {
            editingQuestionId = null;
            document.getElementById('questionModalTitle').textContent = 'æ–°å¢é¡Œç›®';
            document.getElementById('questionForm').reset();
            document.getElementById('modalQuestionType').value = 'short_answer';
            document.getElementById('modalTimeLimit').value = 60;
            document.getElementById('modalAnswerLimit').value = '';
            document.getElementById('modalQuestionOptions').value = '';
            document.getElementById('modalOptionsGroup').style.display = 'none';
            document.getElementById('questionModal').classList.add('active');
        }
        
        // é—œé–‰é¡Œç›®æ¨¡æ…‹æ¡†
        function closeQuestionModal() {
            document.getElementById('questionModal').classList.remove('active');
            editingQuestionId = null;
        }
        
        // åˆ‡æ›é¸é …æ¬„ä½é¡¯ç¤º
        function toggleOptionsField() {
            const type = document.getElementById('modalQuestionType').value;
            const optionsGroup = document.getElementById('modalOptionsGroup');
            if (type === 'multiple_choice' || type === 'multiple_select') {
                optionsGroup.style.display = 'block';
            } else {
                optionsGroup.style.display = 'none';
            }
        }
        
        // å„²å­˜é¡Œç›®
        function saveQuestion(event) {
            event.preventDefault();
            
            const type = document.getElementById('modalQuestionType').value;
            const content = document.getElementById('modalQuestionContent').value;
            const timeLimit = parseInt(document.getElementById('modalTimeLimit').value) || 60;
            const answerLimit = document.getElementById('modalAnswerLimit').value;
            let options = [];
            
            if (type === 'multiple_choice' || type === 'multiple_select') {
                const optionsText = document.getElementById('modalQuestionOptions').value;
                options = optionsText.split('\n').filter(o => o.trim());
            }
            
            const payload = {
                type: type,
                content: content,
                options: options,
                time_limit: timeLimit
            };
            
            if (answerLimit && answerLimit.trim() !== '') {
                payload.answer_limit = parseInt(answerLimit);
            }
            
            const url = editingQuestionId ? `/api/questions/${editingQuestionId}` : '/api/questions';
            const method = editingQuestionId ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                closeQuestionModal();
                // é‡æ–°è¼‰å…¥æ´»å‹•ä»¥ç²å–æœ€æ–°çš„ current_question_id
                fetch(`/api/activities/${activityId}`)
                    .then(res => res.json())
                    .then(activity => {
                        currentActivity = activity;
                        loadQuestionsCards(activity.current_question_id);
                    })
                    .catch(err => {
                        console.error('é‡æ–°è¼‰å…¥æ´»å‹•å¤±æ•—:', err);
                        // å³ä½¿å¤±æ•—ä¹Ÿé‡æ–°è¼‰å…¥å¡ç‰‡
                        loadQuestionsCards(currentActivity ? currentActivity.current_question_id : null);
                    });
            })
            .catch(err => {
                console.error('å„²å­˜é¡Œç›®å¤±æ•—:', err);
                alert('å„²å­˜é¡Œç›®å¤±æ•—ï¼Œè«‹é‡è©¦');
            });
        }
        
        // åˆªé™¤é¡Œç›®
        function deleteQuestion(questionId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é¡Œç›®å—ï¼Ÿ')) return;
            
            fetch(`/api/questions/${questionId}`, { method: 'DELETE' })
                .then(() => {
                    // é‡æ–°è¼‰å…¥æ´»å‹•ä»¥ç²å–æœ€æ–°çš„ current_question_id
                    fetch(`/api/activities/${activityId}`)
                        .then(res => res.json())
                        .then(activity => {
                            loadQuestionsCards(activity.current_question_id);
                            // å¦‚æœåˆªé™¤çš„æ˜¯ç•¶å‰é¸ä¸­çš„é¡Œç›®ï¼Œæ¸…é™¤é¸æ“‡
                            if (activity.current_question_id == questionId) {
                                updateActivityQuestion(null);
                                document.getElementById('questionInfo').style.display = 'none';
                            }
                        });
                })
                .catch(err => {
                    console.error('åˆªé™¤é¡Œç›®å¤±æ•—:', err);
                    alert('åˆªé™¤é¡Œç›®å¤±æ•—ï¼Œè«‹é‡è©¦');
                });
        }
        
        function updateActivityQuestion(questionId) {
            const questionIdValue = questionId ? parseInt(questionId) : null;
            fetch(`/api/activities/${activityId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ current_question_id: questionIdValue })
            })
            .then(() => {
                if (currentActivity) {
                    currentActivity.current_question_id = questionIdValue;
                }
                console.log('é¡Œç›®å·²æ›´æ–°ç‚º:', questionIdValue);
            })
            .catch(err => {
                console.error('æ›´æ–°æ´»å‹•é¡Œç›®å¤±æ•—:', err);
            });
        }
        
        function loadCurrentQuestionInfo(questionId, questions) {
            console.log('è¼‰å…¥é¡Œç›®ä¿¡æ¯, questionId:', questionId, 'questions:', questions);
            const question = questions.find(q => parseInt(q.id) === parseInt(questionId));
            if (question) {
                console.log('æ‰¾åˆ°é¡Œç›®:', question);
                currentQuestion = question;
                document.getElementById('currentQuestionName').textContent = question.content.substring(0, 60);
                document.getElementById('currentQuestionTime').textContent = question.time_limit || 60;
                
                // é¡¯ç¤ºå›ç­”æ¬¡æ•¸é™åˆ¶
                const answerLimitInfo = document.getElementById('answerLimitInfo');
                if (question.answer_limit) {
                    answerLimitInfo.textContent = `å›ç­”æ¬¡æ•¸é™åˆ¶ï¼š${question.answer_limit} æ¬¡`;
                } else {
                    answerLimitInfo.textContent = 'å›ç­”æ¬¡æ•¸é™åˆ¶ï¼šç„¡é™åˆ¶';
                }
                
                document.getElementById('questionInfo').style.display = 'block';
                
                // å¦‚æœæœ‰é€²è¡Œä¸­çš„æ¶ç­”ï¼Œå•Ÿå‹•è¨ˆæ™‚å™¨
                fetch(`/api/activities/${activityId}`)
                    .then(res => res.json())
                    .then(activity => {
                        if (activity.status === 'active' && activity.current_question_id === questionId) {
                            startTimer(question.time_limit || 60);
                        }
                    });
            }
        }
        
        function startTimer(seconds) {
            if (timerInterval) clearInterval(timerInterval);
            timeRemaining = seconds;
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                // é€é WebSocket å»£æ’­è¨ˆæ™‚å™¨æ™‚é–“åˆ°æŠ•å½±ç•«é¢
                socket.emit('broadcast_timer', {
                    activity_id: activityId,
                    time_remaining: timeRemaining
                });
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    // è‡ªå‹•çµæŸæ¶ç­”
                    endActivityAutomatically();
                }
            }, 1000);
            
            // ç«‹å³ç™¼é€ä¸€æ¬¡ç•¶å‰æ™‚é–“
            socket.emit('broadcast_timer', {
                activity_id: activityId,
                time_remaining: timeRemaining
            });
        }
        
        function endActivityAutomatically() {
            fetch(`/api/activities/${activityId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'ended' })
            })
            .then(() => {
                loadActivity();
            })
            .catch(err => console.error('è‡ªå‹•çµæŸæ¶ç­”å¤±æ•—:', err));
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const secs = timeRemaining % 60;
            const timerEl = document.getElementById('timerDisplay');
            timerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            
            timerEl.style.color = '#667eea';
            if (timeRemaining <= 10) {
                timerEl.style.color = '#e74c3c';
            } else if (timeRemaining <= 30) {
                timerEl.style.color = '#f39c12';
            }
        }
        
        function startActivity() {
            // å¾å¡ç‰‡ä¸­æ‰¾åˆ°é¸ä¸­çš„é¡Œç›®
            const selectedCard = document.querySelector('.question-card.selected');
            if (!selectedCard) {
                alert('è«‹å…ˆé¸æ“‡é¡Œç›®');
                return;
            }
            
            const questionId = parseInt(selectedCard.dataset.questionId);
            if (!questionId) {
                alert('è«‹å…ˆé¸æ“‡é¡Œç›®');
                return;
            }
            
            // è¼‰å…¥é¡Œç›®ä¿¡æ¯ä»¥å•Ÿå‹•è¨ˆæ™‚å™¨
            fetch('/api/questions')
                .then(res => res.json())
                .then(questions => {
                    const question = questions.find(q => q.id === questionId);
                    if (question) {
                        fetch(`/api/activities/${activityId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                status: 'active',
                                current_question_id: questionId,
                                display_mode: 'question'
                            })
                        })
                        .then(() => {
                            startTimer(question.time_limit || 60);
                            loadActivity();
                        });
                    }
                });
        }
        
        function endActivity() {
            fetch(`/api/activities/${activityId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'ended' })
            })
            .then(() => {
                // åœæ­¢è¨ˆæ™‚å™¨
                if (timerInterval) clearInterval(timerInterval);
                loadActivity();
            });
        }
        
        // æ‰€æœ‰é¡Œç›®æ•¸æ“šï¼ˆç”¨æ–¼è¡¨æ ¼æ§‹å»ºï¼‰
        let allQuestions = [];
        
        // æ§‹å»ºå›ç­”è¡¨æ ¼
        function buildAnswersTable(activity, questions, skipHeader = false) {
            allQuestions = questions;
            currentActivityData = activity; // ä¿å­˜æ´»å‹•æ•¸æ“šä¾›ç¯©é¸ä½¿ç”¨
            
            // ç²å–æ´»å‹•ä¸­çš„æ‰€æœ‰é¡Œç›®ï¼ˆå¦‚æœæœ‰åœ¨æ´»å‹•ä¸­ä½¿ç”¨éï¼‰
            const activityQuestionIds = new Set();
            if (activity.answers && activity.answers.length > 0) {
                activity.answers.forEach(answer => {
                    activityQuestionIds.add(answer.question_id);
                });
            }
            
            // éæ¿¾å‡ºæ´»å‹•ä¸­å¯¦éš›ä½¿ç”¨éçš„é¡Œç›®
            const usedQuestions = questions.filter(q => activityQuestionIds.has(q.id));
            
            // åªåœ¨éœ€è¦æ™‚æ§‹å»ºè¡¨æ ¼æ¨™é¡Œï¼ˆä¸æ˜¯ç¯©é¸æ™‚ï¼‰
            if (!skipHeader) {
                const tableHeader = document.getElementById('tableHeader');
                tableHeader.innerHTML = '<th style="position: sticky; left: 0; background: #667eea; z-index: 2; min-width: 150px;">ç”¨æˆ¶åç¨±</th>';
                usedQuestions.forEach(q => {
                    const th = document.createElement('th');
                    th.textContent = q.content.length > 30 ? q.content.substring(0, 30) + '...' : q.content;
                    th.title = q.content;
                    tableHeader.appendChild(th);
                });
            }
            
            // ç²å–ç”¨æˆ¶åˆ—è¡¨
            const users = activity.users || [];
            
            // çµ„ç¹”å›ç­”æ•¸æ“šï¼šæŒ‰ç”¨æˆ¶åˆ†çµ„
            const answersByUser = {};
            users.forEach(user => {
                answersByUser[user.id] = {
                    user: user,
                    answers: {} // question_id -> [answer1, answer2, ...]
                };
            });
            
            if (activity.answers && activity.answers.length > 0) {
                activity.answers.forEach(answer => {
                    if (!answersByUser[answer.user_id]) {
                        answersByUser[answer.user_id] = {
                            user: { id: answer.user_id, name: answer.user_name, group_name: answer.group_name },
                            answers: {}
                        };
                    }
                    // ä¿å­˜æ‰€æœ‰å›ç­”ï¼ˆæŒ‰é¡Œç›®åˆ†çµ„ï¼‰
                    if (!answersByUser[answer.user_id].answers[answer.question_id]) {
                        answersByUser[answer.user_id].answers[answer.question_id] = [];
                    }
                    answersByUser[answer.user_id].answers[answer.question_id].push(answer);
                });
                
                // å°æ¯å€‹é¡Œç›®çš„å›ç­”æŒ‰æ™‚é–“æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                Object.values(answersByUser).forEach(userData => {
                    Object.keys(userData.answers).forEach(questionId => {
                        userData.answers[questionId].sort((a, b) => 
                            new Date(b.submitted_at) - new Date(a.submitted_at)
                        );
                    });
                });
            }
            
            // æ§‹å»ºè¡¨æ ¼å…§å®¹
            renderAnswersTable(answersByUser, usedQuestions);
        }
        
        // ä¿å­˜æ´»å‹•æ•¸æ“šä¾›ç¯©é¸ä½¿ç”¨
        let currentActivityData = null;
        let currentUsedQuestions = [];
        
        // æ¸²æŸ“å›ç­”è¡¨æ ¼
        function renderAnswersTable(answersByUser, questions) {
            currentUsedQuestions = questions;
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            // ç²å–æœå°‹é—œéµå­—
            const searchKeyword = document.getElementById('userFilter').value.trim().toLowerCase();
            
            // æ ¹æ“šæœå°‹é—œéµå­—ç¯©é¸ç”¨æˆ¶
            let filteredUsers;
            if (searchKeyword === '') {
                filteredUsers = Object.values(answersByUser);
            } else {
                filteredUsers = Object.values(answersByUser).filter(data => {
                    const userName = (data.user.name || '').toLowerCase();
                    const groupName = (data.user.group_name || '').toLowerCase();
                    return userName.includes(searchKeyword) || groupName.includes(searchKeyword);
                });
            }
            
            if (filteredUsers.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="${questions.length + 1}" style="text-align: center; padding: 30px; color: #999;">
                            ${searchKeyword ? 'æ‰¾ä¸åˆ°ç¬¦åˆæœå°‹æ¢ä»¶çš„ç”¨æˆ¶' : 'å°šç„¡å›ç­”ç´€éŒ„'}
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredUsers.forEach(userData => {
                const row = document.createElement('tr');
                
                // ç”¨æˆ¶åç¨±æ¬„
                const userNameCell = document.createElement('td');
                userNameCell.className = 'user-name-cell';
                userNameCell.textContent = `${userData.user.name}${userData.user.group_name ? ' (' + userData.user.group_name + ')' : ''}`;
                row.appendChild(userNameCell);
                
                // æ¯å€‹é¡Œç›®çš„å›ç­”æ¬„
                questions.forEach(question => {
                    const answerCell = document.createElement('td');
                    answerCell.className = 'answer-cell';
                    
                    const answers = userData.answers[question.id];
                    if (answers && answers.length > 0) {
                        // é¡¯ç¤ºæœ€æ–°çš„å›ç­”
                        const latestAnswer = answers[0];
                        const hasMultiple = answers.length > 1;
                        const cellId = `answer-${userData.user.id}-${question.id}`;
                        
                        const answerDiv = document.createElement('div');
                        answerDiv.className = 'answer-main';
                        
                        // æŠ•å½±æŒ‰éˆ•
                        const projectBtn = document.createElement('button');
                        projectBtn.className = 'project-btn';
                        projectBtn.innerHTML = 'ğŸ“º æŠ•å½±';
                        projectBtn.title = 'æŠ•å½±æ­¤å›ç­”åˆ°æŠ•å½±ç•«é¢';
                        projectBtn.onclick = function(e) {
                            e.stopPropagation();
                            projectAnswer(latestAnswer, userData.user, question);
                        };
                        
                        const contentWrapper = document.createElement('div');
                        contentWrapper.style.display = 'flex';
                        contentWrapper.style.alignItems = 'flex-start';
                        contentWrapper.style.gap = '8px';
                        contentWrapper.style.flex = '1';
                        
                        const textDiv = document.createElement('div');
                        textDiv.className = 'answer-text-content';
                        textDiv.textContent = latestAnswer.answer_text;
                        const submittedTime = new Date(latestAnswer.submitted_at).toLocaleString('zh-TW');
                        const autoSubmittedLabel = latestAnswer.auto_submitted ? 'ï¼ˆæ™‚é–“åˆ°è‡ªå‹•æäº¤ï¼‰' : '';
                        textDiv.title = `æäº¤æ™‚é–“: ${submittedTime}${autoSubmittedLabel}`;
                        textDiv.style.flex = '1';
                        
                        // å¦‚æœæ˜¯è‡ªå‹•æäº¤çš„ç­”æ¡ˆï¼Œè¨­ç½®ç‚ºç°è‰²
                        if (latestAnswer.auto_submitted) {
                            textDiv.style.color = '#999';
                            textDiv.style.fontStyle = 'italic';
                        }
                        
                        contentWrapper.appendChild(projectBtn);
                        contentWrapper.appendChild(textDiv);
                        answerDiv.appendChild(contentWrapper);
                        
                        if (hasMultiple) {
                            // é¡¯ç¤ºå›ç­”æ•¸é‡æ¨™ç±¤å’Œå±•é–‹æŒ‰éˆ•
                            const expandDiv = document.createElement('div');
                            const badge = document.createElement('span');
                            badge.className = 'answer-count-badge';
                            badge.textContent = `${answers.length}å€‹å›ç­”`;
                            
                            const expandBtn = document.createElement('button');
                            expandBtn.className = 'expand-btn';
                            expandBtn.textContent = 'å±•é–‹';
                            expandBtn.onclick = function(e) {
                                e.stopPropagation();
                                toggleAnswerExpansion(cellId, answers, expandBtn, userData.user.id, question.id);
                            };
                            
                            expandDiv.appendChild(badge);
                            expandDiv.appendChild(expandBtn);
                            answerDiv.appendChild(expandDiv);
                        }
                        
                        answerCell.appendChild(answerDiv);
                        
                        // å±•é–‹å€åŸŸï¼ˆåˆå§‹éš±è—ï¼‰
                        const expandArea = document.createElement('div');
                        expandArea.id = cellId;
                        expandArea.className = 'answer-list';
                        expandArea.style.display = 'none';
                        answerCell.appendChild(expandArea);
                    } else {
                        answerCell.textContent = '-';
                        answerCell.className += ' no-answer';
                    }
                    row.appendChild(answerCell);
                });
                
                tableBody.appendChild(row);
            });
        }
        
        // åˆ‡æ›å›ç­”å±•é–‹/æ”¶èµ·
        function toggleAnswerExpansion(cellId, answers, btn, userId, questionId) {
            const expandArea = document.getElementById(cellId);
            if (!expandArea) return;
            
            if (expandArea.style.display === 'none') {
                // å±•é–‹ï¼šé¡¯ç¤ºæ‰€æœ‰å›ç­”
                expandArea.innerHTML = '';
                answers.forEach((answer, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'answer-item-history';
                    
                    // æŠ•å½±æŒ‰éˆ•
                    const projectBtn = document.createElement('button');
                    projectBtn.className = 'project-btn';
                    projectBtn.innerHTML = 'ğŸ“º æŠ•å½±';
                    projectBtn.title = 'æŠ•å½±æ­¤å›ç­”åˆ°æŠ•å½±ç•«é¢';
                    projectBtn.onclick = function(e) {
                        e.stopPropagation();
                        // éœ€è¦ç²å–ç”¨æˆ¶å’Œé¡Œç›®è³‡è¨Š
                        fetch(`/api/activities/${activityId}`)
                            .then(res => res.json())
                            .then(activity => {
                                const user = activity.users.find(u => u.id == userId);
                                fetch('/api/questions')
                                    .then(res => res.json())
                                    .then(questions => {
                                        const q = questions.find(q => q.id == questionId);
                                        projectAnswer(answer, user, q);
                                    });
                            });
                    };
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.style.flex = '1';
                    
                    const answerText = document.createElement('div');
                    answerText.textContent = answer.answer_text;
                    answerText.style.marginBottom = '4px';
                    
                    // å¦‚æœæ˜¯è‡ªå‹•æäº¤çš„ç­”æ¡ˆï¼Œè¨­ç½®ç‚ºç°è‰²
                    if (answer.auto_submitted) {
                        answerText.style.color = '#999';
                        answerText.style.fontStyle = 'italic';
                    }
                    
                    const answerTime = document.createElement('div');
                    answerTime.className = 'answer-item-time';
                    const submittedTime = new Date(answer.submitted_at).toLocaleString('zh-TW');
                    const autoSubmittedLabel = answer.auto_submitted ? 'ï¼ˆæ™‚é–“åˆ°è‡ªå‹•æäº¤ï¼‰' : '';
                    answerTime.textContent = `æäº¤æ™‚é–“: ${submittedTime}${autoSubmittedLabel}`;
                    if (answer.auto_submitted) {
                        answerTime.style.color = '#999';
                    }
                    
                    contentDiv.appendChild(answerText);
                    contentDiv.appendChild(answerTime);
                    
                    itemDiv.appendChild(projectBtn);
                    itemDiv.appendChild(contentDiv);
                    expandArea.appendChild(itemDiv);
                });
                
                expandArea.style.display = 'block';
                btn.textContent = 'æ”¶èµ·';
            } else {
                // æ”¶èµ·
                expandArea.style.display = 'none';
                expandArea.innerHTML = '';
                btn.textContent = 'å±•é–‹';
            }
        }
        
        // ç¯©é¸è¡¨æ ¼ï¼ˆå³æ™‚æœå°‹ï¼Œä¸éœ€è¦é‡æ–°è¼‰å…¥æ•¸æ“šï¼‰
        function filterAnswersTable() {
            if (currentActivityData && currentUsedQuestions.length > 0) {
                // é‡æ–°æ§‹å»ºè¡¨æ ¼ä½†ä¿ç•™æ´»å‹•æ•¸æ“š
                buildAnswersTable(currentActivityData, allQuestions, true);
            } else {
                // å¦‚æœæ²’æœ‰ç·©å­˜æ•¸æ“šï¼Œé‡æ–°è¼‰å…¥
                fetch(`/api/activities/${activityId}`)
                    .then(res => res.json())
                    .then(activity => {
                        fetch('/api/questions')
                            .then(res => res.json())
                            .then(questions => {
                                buildAnswersTable(activity, questions);
                            });
                    });
            }
        }
        
        // æ¸…é™¤æœå°‹
        function clearUserFilter() {
            document.getElementById('userFilter').value = '';
            filterAnswersTable();
        }
        
        // åŒ¯å‡º CSV
        function exportToCSV() {
            if (!currentActivityData) {
                alert('è«‹å…ˆè¼‰å…¥æ´»å‹•æ•¸æ“š');
                return;
            }
            
            // é‡æ–°è¼‰å…¥å®Œæ•´çš„æ´»å‹•æ•¸æ“šï¼ˆåŒ…å«æ‰€æœ‰å›ç­”ï¼‰
            fetch(`/api/activities/${activityId}`)
                .then(res => res.json())
                .then(activity => {
                    fetch('/api/questions')
                        .then(res => res.json())
                        .then(questions => {
                            generateCSV(activity, questions);
                        });
                })
                .catch(err => {
                    console.error('è¼‰å…¥æ•¸æ“šå¤±æ•—:', err);
                    alert('åŒ¯å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦');
                });
        }
        
        // ç”Ÿæˆ CSV å…§å®¹
        function generateCSV(activity, questions) {
            // ç²å–æ´»å‹•ä¸­ä½¿ç”¨çš„é¡Œç›®ï¼ˆæŒ‰å›ç­”ä¸­å‡ºç¾çš„é¡Œç›®ï¼‰
            const questionIds = new Set();
            if (activity.answers && activity.answers.length > 0) {
                activity.answers.forEach(answer => {
                    questionIds.add(answer.question_id);
                });
            }
            
            const usedQuestions = questions.filter(q => questionIds.has(q.id));
            
            // æ§‹å»ºç”¨æˆ¶å›ç­”æ˜ å°„
            const users = activity.users || [];
            const answersByUser = {};
            users.forEach(user => {
                answersByUser[user.id] = {
                    user: user,
                    answers: {}
                };
            });
            
            if (activity.answers && activity.answers.length > 0) {
                activity.answers.forEach(answer => {
                    if (!answersByUser[answer.user_id]) {
                        answersByUser[answer.user_id] = {
                            user: { id: answer.user_id, name: answer.user_name, group_name: answer.group_name },
                            answers: {}
                        };
                    }
                    if (!answersByUser[answer.user_id].answers[answer.question_id]) {
                        answersByUser[answer.user_id].answers[answer.question_id] = [];
                    }
                    answersByUser[answer.user_id].answers[answer.question_id].push(answer);
                });
            }
            
            // æ§‹å»º CSV å…§å®¹
            const csvRows = [];
            
            // æ¨™é¡Œè¡Œ
            const headers = ['ç”¨æˆ¶åç¨±', 'å°çµ„'];
            usedQuestions.forEach(q => {
                headers.push(`"${q.content.replace(/"/g, '""')}"`);
            });
            csvRows.push(headers.join(','));
            
            // æ•¸æ“šè¡Œ
            Object.values(answersByUser).forEach(userData => {
                const row = [];
                row.push(`"${(userData.user.name || '').replace(/"/g, '""')}"`);
                row.push(`"${(userData.user.group_name || '').replace(/"/g, '""')}"`);
                
                usedQuestions.forEach(question => {
                    const answers = userData.answers[question.id];
                    if (answers && answers.length > 0) {
                        // å°‡æ‰€æœ‰å›ç­”ç”¨åˆ†è™Ÿåˆ†éš”
                        const answerTexts = answers.map(a => 
                            a.answer_text.replace(/"/g, '""').replace(/\n/g, ' ')
                        );
                        row.push(`"${answerTexts.join('; ')}"`);
                    } else {
                        row.push('');
                    }
                });
                
                csvRows.push(row.join(','));
            });
            
            // å‰µå»º CSV å…§å®¹
            const csvContent = csvRows.join('\n');
            
            // æ·»åŠ  BOM ä»¥æ”¯æŒä¸­æ–‡åœ¨ Excel ä¸­æ­£ç¢ºé¡¯ç¤º
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `æ´»å‹•_${activity.name || activityId}_å›ç­”ç´€éŒ„_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('CSV å·²åŒ¯å‡º');
        }
        
        // æŠ•å½±å›ç­”åˆ°æŠ•å½±ç•«é¢
        function projectAnswer(answer, user, question) {
            if (!answer) {
                console.error('ç„¡æ³•æŠ•å½±ï¼šå›ç­”æ•¸æ“šç‚ºç©º');
                return;
            }
            
            // æº–å‚™å›ç­”æ•¸æ“š
            const answerData = {
                answer_text: answer.answer_text || '',
                user_name: user ? user.name : (answer.user_name || 'æœªçŸ¥ç”¨æˆ¶'),
                group_name: user ? (user.group_name || '') : (answer.group_name || ''),
                question_content: question ? question.content : '',
                submitted_at: answer.submitted_at || new Date().toISOString()
            };
            
            // è¨­ç½®é¡¯ç¤ºæ¨¡å¼ç‚º answerï¼Œä¸¦é€šé WebSocket ç™¼é€å›ç­”æ•¸æ“š
            fetch(`/api/activities/${activityId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    display_mode: 'answer',
                    projected_answer: answerData
                })
            })
            .then(() => {
                // é€šé WebSocket ç™¼é€å›ç­”æ•¸æ“šåˆ°æŠ•å½±ç•«é¢
                socket.emit('project_answer', {
                    activity_id: activityId,
                    answer: answerData
                });
                console.log('å›ç­”å·²æŠ•å½±:', answerData);
            })
            .catch(err => {
                console.error('æŠ•å½±å›ç­”å¤±æ•—:', err);
                alert('æŠ•å½±å›ç­”å¤±æ•—ï¼Œè«‹é‡è©¦');
            });
        }
        
        // ç›£è½å›ç­”æäº¤ï¼ˆæ›´æ–°å›ç­”åˆ—è¡¨ï¼Œä½†ä¸å½±éŸ¿è¨ˆæ™‚å™¨ï¼‰
        socket.on('answer_submitted', (data) => {
            if (data.activity_id === activityId) {
                // é‡æ–°è¼‰å…¥æ´»å‹•å’Œè¡¨æ ¼
                fetch(`/api/activities/${activityId}`)
                    .then(res => res.json())
                    .then(activity => {
                        fetch('/api/questions')
                            .then(res => res.json())
                            .then(questions => {
                                buildAnswersTable(activity, questions);
                            });
                    });
            }
        });
        
        // ç›£è½ä½¿ç”¨è€…åˆªé™¤äº‹ä»¶
        socket.on('user_deleted', (data) => {
            if (data.activity_id === activityId) {
                // é‡æ–°è¼‰å…¥æ´»å‹•ã€è¡¨æ ¼å’Œåƒèˆ‡è€…åˆ—è¡¨
                loadActivity();
                loadParticipants();
            }
        });
        
        // ç›£è½æ´»å‹•ç‹€æ…‹æ›´æ–°
        socket.on('activity_updated', (data) => {
            if (data.activity_id === activityId) {
                // æ›´æ–° currentActivity
                if (data.updates.status) {
                    if (currentActivity) currentActivity.status = data.updates.status;
                }
                if (data.updates.current_question_id !== undefined) {
                    if (currentActivity) currentActivity.current_question_id = data.updates.current_question_id;
                }
                
                if (data.updates.status === 'active' && data.updates.current_question_id) {
                    // åªæœ‰ç•¶é¡Œç›®æ”¹è®Šæ™‚æ‰é‡æ–°è¼‰å…¥
                    if (!currentQuestion || currentQuestion.id !== data.updates.current_question_id) {
                        fetch('/api/questions')
                            .then(res => res.json())
                            .then(questions => {
                                loadCurrentQuestionInfo(data.updates.current_question_id, questions);
                                // æ›´æ–°å¡ç‰‡é¸ä¸­ç‹€æ…‹
                                document.querySelectorAll('.question-card').forEach(card => {
                                    card.classList.remove('selected');
                                    if (card.dataset.questionId == data.updates.current_question_id) {
                                        card.classList.add('selected');
                                    }
                                });
                            });
                    }
                } else if (data.updates.status === 'ended') {
                    if (timerInterval) clearInterval(timerInterval);
                    document.getElementById('timerDisplay').textContent = '--:--';
                    // éš±è—æ¢å¾©æŒ‰éˆ•
                    const questionInfo = document.getElementById('questionInfo');
                    if (questionInfo) {
                        questionInfo.style.display = 'none';
                    }
                    loadActivity(); // é‡æ–°è¼‰å…¥æ•´å€‹æ´»å‹•
                }
            }
        });
        
        // ç›£è½é¡Œç›®æ›´æ–°
        socket.on('question_created', (data) => {
            console.log('é¡Œç›®å·²å‰µå»ºï¼Œé‡æ–°è¼‰å…¥å¡ç‰‡');
            fetch(`/api/activities/${activityId}`)
                .then(res => res.json())
                .then(activity => {
                    currentActivity = activity;
                    loadQuestionsCards(activity.current_question_id);
                })
                .catch(err => {
                    console.error('è¼‰å…¥æ´»å‹•å¤±æ•—:', err);
                    loadQuestionsCards(currentActivity ? currentActivity.current_question_id : null);
                });
        });
        
        socket.on('question_updated', (data) => {
            console.log('é¡Œç›®å·²æ›´æ–°ï¼Œé‡æ–°è¼‰å…¥å¡ç‰‡');
            fetch(`/api/activities/${activityId}`)
                .then(res => res.json())
                .then(activity => {
                    currentActivity = activity;
                    loadQuestionsCards(activity.current_question_id);
                })
                .catch(err => {
                    console.error('è¼‰å…¥æ´»å‹•å¤±æ•—:', err);
                    loadQuestionsCards(currentActivity ? currentActivity.current_question_id : null);
                });
        });
        
        socket.on('question_deleted', (data) => {
            console.log('é¡Œç›®å·²åˆªé™¤ï¼Œé‡æ–°è¼‰å…¥å¡ç‰‡');
            fetch(`/api/activities/${activityId}`)
                .then(res => res.json())
                .then(activity => {
                    currentActivity = activity;
                    loadQuestionsCards(activity.current_question_id);
                    // å¦‚æœåˆªé™¤çš„æ˜¯ç•¶å‰é¸ä¸­çš„é¡Œç›®ï¼Œæ¸…é™¤é¸æ“‡
                    if (activity.current_question_id == data.id) {
                        updateActivityQuestion(null);
                        document.getElementById('questionInfo').style.display = 'none';
                    }
                })
                .catch(err => {
                    console.error('è¼‰å…¥æ´»å‹•å¤±æ•—:', err);
                    loadQuestionsCards(currentActivity ? currentActivity.current_question_id : null);
                });
        });
        
        // è¼‰å…¥åƒèˆ‡è€…åˆ—è¡¨
        function loadParticipants() {
            fetch(`/api/activities/${activityId}`)
                .then(res => res.json())
                .then(activity => {
                    const participantsList = document.getElementById('participantsList');
                    const users = activity.users || [];
                    
                    if (users.length === 0) {
                        participantsList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">å°šç„¡åƒèˆ‡è€…</div>';
                        return;
                    }
                    
                    // æŒ‰å°çµ„åˆ†çµ„
                    const usersByGroup = {};
                    users.forEach(user => {
                        const group = user.group_name || 'æœªåˆ†çµ„';
                        if (!usersByGroup[group]) {
                            usersByGroup[group] = [];
                        }
                        usersByGroup[group].push(user);
                    });
                    
                    let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">';
                    
                    Object.keys(usersByGroup).sort().forEach(group => {
                        html += `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                <h4 style="margin-bottom: 10px; color: #667eea;">${group}</h4>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                        `;
                        
                        usersByGroup[group].forEach(user => {
                            html += `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 4px;">
                                    <span>${user.name}</span>
                                    <button class="danger" onclick="deleteUser(${user.id}, '${user.name.replace(/'/g, "\\'")}')" 
                                            style="padding: 4px 8px; font-size: 11px;">
                                        ğŸ—‘ï¸ åˆªé™¤
                                    </button>
                                </div>
                            `;
                        });
                        
                        html += '</div></div>';
                    });
                    
                    html += '</div>';
                    participantsList.innerHTML = html;
                })
                .catch(err => {
                    console.error('è¼‰å…¥åƒèˆ‡è€…åˆ—è¡¨å¤±æ•—:', err);
                    document.getElementById('participantsList').innerHTML = '<div style="text-align: center; color: #e74c3c; padding: 20px;">è¼‰å…¥å¤±æ•—</div>';
                });
        }
        
        // åˆªé™¤ä½¿ç”¨è€…
        function deleteUser(userId, userName) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ä½¿ç”¨è€…ã€Œ${userName}ã€å—ï¼Ÿ\næ­¤æ“ä½œå°‡åŒæ™‚åˆªé™¤è©²ä½¿ç”¨è€…çš„æ‰€æœ‰å›ç­”ç´€éŒ„ï¼Œä¸”ç„¡æ³•å¾©åŸã€‚`)) {
                return;
            }
            
            fetch(`/api/users/${userId}`, {
                method: 'DELETE'
            })
            .then(res => {
                if (!res.ok) {
                    return res.json().then(data => {
                        throw new Error(data.error || 'åˆªé™¤å¤±æ•—');
                    });
                }
                return res.json();
            })
            .then(() => {
                // é‡æ–°è¼‰å…¥æ´»å‹•å’Œåƒèˆ‡è€…åˆ—è¡¨
                loadActivity();
                loadParticipants();
                console.log('ä½¿ç”¨è€…å·²åˆªé™¤');
            })
            .catch(err => {
                console.error('åˆªé™¤ä½¿ç”¨è€…å¤±æ•—:', err);
                alert('åˆªé™¤ä½¿ç”¨è€…å¤±æ•—ï¼š' + err.message);
            });
        }
        
        // è¼‰å…¥æ´»å‹•è³‡æ–™
        loadActivity();
    </script>
</body>
</html>

