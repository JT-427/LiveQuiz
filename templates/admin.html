<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å³æ™‚å•ç­” - ç®¡ç†ä»‹é¢</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { color: #333; margin-bottom: 30px; }
        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 15px 30px;
            cursor: pointer;
            background: #e9e9e9;
            border: none;
            font-size: 16px;
            font-weight: bold;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            margin-right: 5px;
        }
        .tab.active {
            background: #667eea;
            color: white;
        }
        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .tab-content.active { display: block; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: bold; }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        textarea { min-height: 100px; resize: vertical; }
        button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { opacity: 0.9; }
        button.danger { background: #e74c3c; }
        button.success { background: #27ae60; }
        
        .question-list, .activity-list {
            margin-top: 20px;
        }
        .question-item, .activity-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .question-info, .activity-info {
            flex: 1;
        }
        .question-title { font-weight: bold; color: #333; margin-bottom: 5px; }
        .question-meta { color: #666; font-size: 14px; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .close-btn {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        .answers-list {
            margin-top: 20px;
        }
        .answer-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid #27ae60;
        }
        .answer-user {
            font-weight: bold;
            color: #333;
        }
        .answer-text {
            margin-top: 5px;
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ›ï¸ ç®¡ç†ä»‹é¢</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('questions')">é¡Œç›®ç®¡ç†</button>
            <button class="tab" onclick="switchTab('activities')">æ´»å‹•ç®¡ç†</button>
        </div>
        
        <!-- é¡Œç›®ç®¡ç† -->
        <div id="questionsTab" class="tab-content active">
            <h2>æ–°å¢é¡Œç›®</h2>
            <form id="questionForm" onsubmit="createQuestion(event)">
                <div class="form-group">
                    <label>é¡Œå‹</label>
                    <select id="questionType" required>
                        <option value="short_answer">ç°¡ç­”é¡Œ</option>
                        <option value="multiple_choice">é¸æ“‡é¡Œ</option>
                        <option value="multiple_select">å¤šé¸é¡Œ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é¡Œç›®å…§å®¹</label>
                    <textarea id="questionContent" required></textarea>
                </div>
                <div class="form-group" id="optionsGroup" style="display:none;">
                    <label>é¸é …ï¼ˆæ¯è¡Œä¸€å€‹ï¼‰</label>
                    <textarea id="questionOptions"></textarea>
                </div>
                <div class="form-group">
                    <label>å›ç­”æ™‚é–“é™åˆ¶ï¼ˆç§’ï¼‰</label>
                    <input type="number" id="timeLimit" value="60" min="1">
                </div>
                <div class="form-group">
                    <label>å›ç­”æ¬¡æ•¸é™åˆ¶ï¼ˆé¸å¡«ï¼Œç•™ç©ºè¡¨ç¤ºç„¡é™åˆ¶ï¼‰</label>
                    <input type="number" id="answerLimit" placeholder="ä¾‹å¦‚ï¼š3ï¼ˆæ¯ä½ä½¿ç”¨è€…æœ€å¤šå¯å›ç­”3æ¬¡ï¼‰" min="1">
                    <small style="color: #999; display: block; margin-top: 5px;">ç•™ç©ºè¡¨ç¤ºæ¯ä½ä½¿ç”¨è€…å¯ç„¡é™åˆ¶å›ç­”</small>
                </div>
                <button type="submit">æ–°å¢é¡Œç›®</button>
            </form>
            
            <div class="question-list" id="questionList"></div>
        </div>
        
        <!-- æ´»å‹•ç®¡ç† -->
        <div id="activitiesTab" class="tab-content">
            <h2>å»ºç«‹æ–°æ´»å‹•</h2>
            <div class="form-group">
                <label>æ´»å‹•åç¨±</label>
                <input type="text" id="activityName" placeholder="è«‹è¼¸å…¥æ´»å‹•åç¨±">
            </div>
            <div class="form-group">
                <label>å°çµ„è¨­å®šï¼ˆé¸å¡«ï¼‰</label>
                <input type="text" id="groupsText" placeholder="ä¾‹å¦‚ï¼šç¬¬1çµ„,ç¬¬2çµ„,ç¬¬3çµ„ æˆ–ç•™ç©ºè¡¨ç¤ºä¸åˆ†çµ„">
                <small style="color: #999; display: block; margin-top: 5px;">è«‹ç”¨é€—è™Ÿåˆ†éš”å¤šå€‹å°çµ„åç¨±</small>
            </div>
            <button onclick="createActivity()">å»ºç«‹æ´»å‹•</button>
            
            <div class="activity-list" id="activityList"></div>
        </div>
    </div>
    
    <!-- æ´»å‹•è©³æƒ…æ¨¡æ…‹æ¡† -->
    <div class="modal" id="activityModal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeActivityModal()">&times;</span>
            <h2 id="modalActivityName"></h2>
            <div id="activityDetails"></div>
        </div>
    </div>

    <script>
        const socket = io();
        
        // é¡Œå‹è®Šæ›´æ™‚é¡¯ç¤º/éš±è—é¸é …è¼¸å…¥
        document.getElementById('questionType').addEventListener('change', function() {
            const optionsGroup = document.getElementById('optionsGroup');
            if (this.value === 'multiple_choice' || this.value === 'multiple_select') {
                optionsGroup.style.display = 'block';
            } else {
                optionsGroup.style.display = 'none';
            }
        });
        
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
            
            if (tab === 'questions') {
                loadQuestions();
            } else {
                loadActivities();
            }
        }
        
        function createQuestion(e) {
            e.preventDefault();
            const type = document.getElementById('questionType').value;
            const content = document.getElementById('questionContent').value;
            const timeLimit = parseInt(document.getElementById('timeLimit').value) || 60;
            const answerLimit = document.getElementById('answerLimit').value;
            let options = [];
            
            if (type === 'multiple_choice' || type === 'multiple_select') {
                const optionsText = document.getElementById('questionOptions').value;
                options = optionsText.split('\n').filter(o => o.trim());
            }
            
            const payload = {
                type: type,
                content: content,
                options: options,
                time_limit: timeLimit
            };
            
            if (answerLimit && answerLimit.trim() !== '') {
                payload.answer_limit = parseInt(answerLimit);
            }
            
            fetch('/api/questions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('questionForm').reset();
                document.getElementById('optionsGroup').style.display = 'none';
                loadQuestions();
            })
            .catch(err => console.error(err));
        }
        
        function loadQuestions() {
            fetch('/api/questions')
                .then(res => res.json())
                .then(questions => {
                    const list = document.getElementById('questionList');
                    list.innerHTML = '';
                    questions.forEach(q => {
                        const item = document.createElement('div');
                        item.className = 'question-item';
                        item.innerHTML = `
                            <div class="question-info">
                                <div class="question-title">${q.content}</div>
                                <div class="question-meta">
                                    é¡å‹: ${getQuestionTypeName(q.type)} | 
                                    æ™‚é–“é™åˆ¶: ${q.time_limit || 60}ç§’
                                    ${q.answer_limit ? `| å›ç­”æ¬¡æ•¸é™åˆ¶: ${q.answer_limit}æ¬¡` : '| å›ç­”æ¬¡æ•¸: ç„¡é™åˆ¶'}
                                </div>
                            </div>
                            <button class="danger" onclick="deleteQuestion(${q.id})">åˆªé™¤</button>
                        `;
                        list.appendChild(item);
                    });
                });
        }
        
        function getQuestionTypeName(type) {
            const names = {
                'short_answer': 'ç°¡ç­”é¡Œ',
                'multiple_choice': 'é¸æ“‡é¡Œ',
                'multiple_select': 'å¤šé¸é¡Œ'
            };
            return names[type] || type;
        }
        
        function deleteQuestion(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é¡Œç›®å—ï¼Ÿ')) return;
            fetch(`/api/questions/${id}`, { method: 'DELETE' })
                .then(() => loadQuestions());
        }
        
        function createActivity() {
            const name = document.getElementById('activityName').value;
            if (!name) {
                alert('è«‹è¼¸å…¥æ´»å‹•åç¨±');
                return;
            }
            
            const groupsText = document.getElementById('groupsText').value.trim();
            let groups = null;
            if (groupsText) {
                groups = groupsText.split(',').map(g => g.trim()).filter(g => g !== '');
            }
            
            fetch('/api/activities', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    name: name,
                    groups: groups
                })
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('activityName').value = '';
                document.getElementById('groupsText').value = '';
                loadActivities();
            })
            .catch(err => console.error(err));
        }
        
        function loadActivities() {
            fetch('/api/activities')
                .then(res => res.json())
                .then(activities => {
                    const list = document.getElementById('activityList');
                    list.innerHTML = '';
                    activities.forEach(a => {
                        const item = document.createElement('div');
                        item.className = 'activity-item';
                        item.innerHTML = `
                            <div class="activity-info">
                                <div class="question-title">${a.name}</div>
                                <div class="question-meta">ç‹€æ…‹: ${getStatusName(a.status)}</div>
                            </div>
                            <div>
                                <button onclick="window.location.href='/admin/activity/${a.id}'">ç®¡ç†</button>
                            </div>
                        `;
                        list.appendChild(item);
                    });
                });
        }
        
        function getStatusName(status) {
            const names = {
                'preparing': 'æº–å‚™ä¸­',
                'active': 'é€²è¡Œä¸­',
                'ended': 'å·²çµæŸ'
            };
            return names[status] || status;
        }
        
        function openActivityModal(activityId) {
            fetch(`/api/activities/${activityId}`)
                .then(res => res.json())
                .then(activity => {
                    document.getElementById('modalActivityName').textContent = activity.name;
                    const details = document.getElementById('activityDetails');
                    
                    let html = `
                        <div style="margin-bottom: 30px;">
                            <h3>æ´»å‹•è¨­å®š</h3>
                            <div class="form-group">
                                <label>å°çµ„æ•¸é‡</label>
                                <input type="number" id="modalGroupsCount" value="${activity.groups_count || ''}" placeholder="ä¸å¡«è¡¨ç¤ºä¸åˆ†çµ„" min="0" style="width: 100%; padding: 8px;">
                            </div>
                            <button onclick="updateGroupsCount(${activityId})" style="margin-top: 10px;">æ›´æ–°å°çµ„æ•¸é‡</button>
                        </div>
                        
                        <div style="margin-bottom: 30px; padding: 20px; background: #f0f0f0; border-radius: 8px;">
                            <h3>ğŸ“º æŠ•å½±ç•«é¢æ§åˆ¶</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 15px;">
                                <button class="success" onclick="showDisplay('qrcode', ${activityId})" style="padding: 15px;">
                                    ğŸ“± é¡¯ç¤º QR Code
                                </button>
                                <button class="success" onclick="showDisplay('stats', ${activityId})" style="padding: 15px;">
                                    ğŸ“Š é¡¯ç¤ºçµ±è¨ˆæ•¸æ“š
                                </button>
                                <button class="success" onclick="showDisplay('question', ${activityId})" style="padding: 15px;">
                                    â“ é¡¯ç¤ºé¡Œç›®
                                </button>
                                <button onclick="showDisplay('none', ${activityId})" style="padding: 15px; background: #95a5a6;">
                                    â¬› é—œé–‰é¡¯ç¤º
                                </button>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 30px;">
                            <h3>æ¶ç­”æ§åˆ¶</h3>
                            <div class="form-group">
                                <label>é¸æ“‡é¡Œç›®</label>
                                <select id="questionSelect" style="width: 100%; padding: 8px; margin: 10px 0;">
                                    <option value="">è«‹é¸æ“‡é¡Œç›®</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button class="success" onclick="startActivity(${activityId})">é–‹å§‹æ¶ç­”</button>
                                <button class="danger" onclick="endActivity(${activityId})">çµæŸæ¶ç­”</button>
                            </div>
                        </div>
                        
                        <div>
                            <h3>å›ç­”ç´€éŒ„</h3>
                            <div class="answers-list" id="answersList"></div>
                        </div>
                    `;
                    
                    details.innerHTML = html;
                    
                    // è¼‰å…¥é¡Œç›®åˆ—è¡¨
                    fetch('/api/questions')
                        .then(res => res.json())
                        .then(questions => {
                            const select = document.getElementById('questionSelect');
                            questions.forEach(q => {
                                const option = document.createElement('option');
                                option.value = q.id;
                                option.textContent = q.content.substring(0, 50);
                                select.appendChild(option);
                            });
                            if (activity.current_question_id) {
                                select.value = activity.current_question_id;
                            }
                            select.addEventListener('change', function() {
                                updateActivityQuestion(activityId, this.value);
                            });
                        });
                    
                    // é¡¯ç¤ºå›ç­”
                    const answersList = document.getElementById('answersList');
                    if (activity.answers && activity.answers.length > 0) {
                        activity.answers.forEach(answer => {
                            const item = document.createElement('div');
                            item.className = 'answer-item';
                            item.innerHTML = `
                                <div class="answer-user">${answer.user_name} (${answer.group_name || 'ç„¡'})</div>
                                <div class="answer-text">${answer.answer_text}</div>
                            `;
                            answersList.appendChild(item);
                        });
                    } else {
                        answersList.innerHTML = '<p>å°šç„¡å›ç­”</p>';
                    }
                    
                    document.getElementById('modalActivityName').dataset.activityId = activityId;
                    document.getElementById('activityModal').classList.add('active');
                });
        }
        
        function closeActivityModal() {
            document.getElementById('activityModal').classList.remove('active');
        }
        
        function updateActivityQuestion(activityId, questionId) {
            fetch(`/api/activities/${activityId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ current_question_id: parseInt(questionId) || null })
            });
        }
        
        function updateGroupsCount(activityId) {
            const groupsCount = document.getElementById('modalGroupsCount').value;
            fetch(`/api/activities/${activityId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    groups_count: groupsCount ? parseInt(groupsCount) : null
                })
            })
            .then(() => {
                alert('å°çµ„æ•¸é‡å·²æ›´æ–°');
                openActivityModal(activityId);
            });
        }
        
        function showDisplay(mode, activityId) {
            fetch(`/api/activities/${activityId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ display_mode: mode })
            })
            .then(() => {
                const modeNames = {
                    'qrcode': 'QR Code',
                    'stats': 'çµ±è¨ˆæ•¸æ“š',
                    'question': 'é¡Œç›®',
                    'none': 'é—œé–‰'
                };
                alert(`æŠ•å½±ç•«é¢å·²åˆ‡æ›ç‚ºï¼š${modeNames[mode] || mode}`);
            });
        }
        
        function startActivity(activityId) {
            const questionId = document.getElementById('questionSelect').value;
            if (!questionId) {
                alert('è«‹å…ˆé¸æ“‡é¡Œç›®');
                return;
            }
            
            fetch(`/api/activities/${activityId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    status: 'active',
                    current_question_id: parseInt(questionId),
                    display_mode: 'question'
                })
            })
            .then(() => {
                alert('æ¶ç­”å·²é–‹å§‹ï¼');
                openActivityModal(activityId);
            });
        }
        
        function endActivity(activityId) {
            fetch(`/api/activities/${activityId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'ended' })
            })
            .then(() => {
                alert('æ¶ç­”å·²çµæŸ');
                openActivityModal(activityId);
            });
        }
        
        // ç›£è½å›ç­”æäº¤
        socket.on('answer_submitted', (data) => {
            const modal = document.getElementById('activityModal');
            if (modal.classList.contains('active')) {
                // é‡æ–°è¼‰å…¥æ´»å‹•è©³æƒ…
                const activityIdStr = document.getElementById('modalActivityName').dataset.activityId;
                if (activityIdStr && parseInt(activityIdStr) === data.activity_id) {
                    openActivityModal(parseInt(activityIdStr));
                }
            }
        });
        
        // è¼‰å…¥åˆå§‹è³‡æ–™
        loadQuestions();
    </script>
</body>
</html>

