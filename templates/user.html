<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å³æ™‚å•ç­” - ä½¿ç”¨è€…</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            transition: background 0.3s ease;
        }
        body.flash-red {
            animation: flashRed 1s ease-in-out;
        }
        @keyframes flashRed {
            0% { 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            50% { 
                background: linear-gradient(135deg, var(--flash-color-start) 0%, var(--flash-color-end) 100%);
            }
            100% { 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 { text-align: center; color: #333; margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: bold; }
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { opacity: 0.9; transform: translateY(-2px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .waiting-screen {
            text-align: center;
            display: none;
        }
        .waiting-screen.active { display: block; }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .answer-screen {
            display: none;
        }
        .answer-screen.active { display: block; }
        
        .ended-screen {
            display: none;
            text-align: center;
        }
        .ended-screen.active { display: block; }
        .question-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            min-height: 150px;
            resize: vertical;
        }
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            display: none;
        }
        .success-message.show { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <!-- ç™»å…¥è¡¨å–® -->
        <div id="loginForm">
            <h1>ğŸ¯ å³æ™‚å•ç­”ç³»çµ±</h1>
            <div class="form-group">
                <label>æ‚¨çš„åå­—</label>
                <input type="text" id="userName" placeholder="è«‹è¼¸å…¥æ‚¨çš„åå­—" required>
            </div>
            <div class="form-group">
                <label>æ´»å‹• ID</label>
                <input type="number" id="activityId" placeholder="è«‹è¼¸å…¥æ´»å‹• ID" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                <div id="activityIdError" style="color: #e74c3c; font-size: 14px; margin-top: 5px; display: none;">
                    âš ï¸ è«‹é‡æ–°æƒæ QR Code
                </div>
            </div>
            <div class="form-group" id="groupSelectContainer" style="display:none;">
                <label>é¸æ“‡å°çµ„ <span style="color: #e74c3c;">*</span></label>
                <select id="groupSelect" required style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                    <option value="">è«‹é¸æ“‡å°çµ„</option>
                </select>
            </div>
            <div class="form-group" id="groupInputContainer" style="display:none;">
                <label>æ‰€å±¬å°çµ„ <span style="color: #e74c3c;">*</span></label>
                <input type="text" id="groupName" placeholder="è«‹è¼¸å…¥å°çµ„åç¨±" required>
            </div>
            <button onclick="joinActivity()">é€²å…¥æº–å‚™</button>
        </div>
        
        <!-- ç­‰å¾…ç•«é¢ -->
        <div class="waiting-screen" id="waitingScreen">
            <h1>â³ ç­‰å¾…é–‹å§‹</h1>
            <div class="spinner"></div>
            <p style="margin-top: 20px; color: #666;">è«‹ç­‰å¾…ä¸»æŒäººé–‹å§‹æ¶ç­”...</p>
        </div>
        
        <!-- å›ç­”ç•«é¢ -->
        <div class="answer-screen" id="answerScreen">
            <div class="question-box">
                <h2>é¡Œç›®</h2>
                <p id="questionContent" style="font-size: 18px; margin-top: 10px;"></p>
            </div>
            <div class="form-group">
                <label>æ‚¨çš„å›ç­”</label>
                <textarea id="answerText" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„ç­”æ¡ˆ..."></textarea>
            </div>
            <button onclick="submitAnswer()" id="submitBtn">é€å‡ºç­”æ¡ˆ</button>
            <div class="success-message" id="successMsg">ç­”æ¡ˆå·²æˆåŠŸé€å‡ºï¼</div>
        </div>
        
        <!-- æ¶ç­”çµæŸç•«é¢ -->
        <div class="ended-screen" id="endedScreen">
            <h1>â¹ï¸ æ¶ç­”å·²çµæŸ</h1>
            <div style="text-align: center; margin-top: 30px;">
                <p style="font-size: 20px; color: #666; margin-bottom: 20px;">æœ¬æ¬¡æ¶ç­”å·²çµæŸï¼Œæ„Ÿè¬æ‚¨çš„åƒèˆ‡ï¼</p>
                <div id="finalStatus" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <p style="color: #555;">ç­‰å¾…ä¸‹ä¸€é¡Œ...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let userId = null;
        let activityId = null;
        let currentQuestion = null;
        let remainingAnswers = null; // å‰©ä½™å¯å›ç­”æ¬¡æ•°
        let timeRemaining = 0; // å‰©ä½™æ™‚é–“ï¼ˆç§’ï¼‰
        
        // å¾ URL å–å¾— activity ID
        const urlParams = new URLSearchParams(window.location.search);
        const urlActivityId = urlParams.get('activity');
        const activityIdInput = document.getElementById('activityId');
        const activityIdError = document.getElementById('activityIdError');
        
        if (urlActivityId) {
            activityIdInput.value = urlActivityId;
            activityIdError.style.display = 'none';
            loadActivityGroups(urlActivityId);
        } else {
            // æ²’æœ‰æ´»å‹• IDï¼Œé¡¯ç¤ºéŒ¯èª¤æç¤º
            activityIdError.style.display = 'block';
            document.getElementById('groupSelectContainer').style.display = 'none';
            document.getElementById('groupInputContainer').style.display = 'none';
        }
        
        function loadActivityGroups(activityId) {
            fetch(`/api/activities/${activityId}/groups`)
                .then(res => res.json())
                .then(data => {
                    const selectContainer = document.getElementById('groupSelectContainer');
                    const inputContainer = document.getElementById('groupInputContainer');
                    
                    if (data.groups_count && data.groups_count > 0) {
                        // æœ‰è¨­å®šå°çµ„ï¼Œé¡¯ç¤ºä¸‹æ‹‰é¸å–®
                        selectContainer.style.display = 'block';
                        inputContainer.style.display = 'none';
                        
                        const select = document.getElementById('groupSelect');
                        select.innerHTML = '<option value="">è«‹é¸æ“‡å°çµ„</option>';
                        data.groups.forEach(group => {
                            const option = document.createElement('option');
                            option.value = group;
                            option.textContent = group;
                            select.appendChild(option);
                        });
                    } else {
                        // æ²’æœ‰è¨­å®šå°çµ„ï¼Œé¡¯ç¤ºæ–‡å­—è¼¸å…¥æ¡†
                        selectContainer.style.display = 'none';
                        inputContainer.style.display = 'block';
                    }
                })
                .catch(err => {
                    // å¦‚æœæ´»å‹•ä¸å­˜åœ¨ï¼Œéš±è—å°çµ„é¸æ“‡
                    document.getElementById('groupSelectContainer').style.display = 'none';
                    document.getElementById('groupInputContainer').style.display = 'none';
                });
        }
        
        function joinActivity() {
            const name = document.getElementById('userName').value;
            activityId = parseInt(document.getElementById('activityId').value);
            
            // é©—è­‰æ´»å‹• ID
            if (!activityId) {
                alert('è«‹é‡æ–°æƒæ QR Code');
                return;
            }
            
            // å–å¾—å°çµ„åç¨±
            let groupName = '';
            const groupSelect = document.getElementById('groupSelect');
            const groupInput = document.getElementById('groupName');
            
            if (groupSelect.style.display !== 'none') {
                if (!groupSelect.value) {
                    alert('è«‹é¸æ“‡å°çµ„');
                    groupSelect.focus();
                    return;
                }
                groupName = groupSelect.value;
            } else if (groupInput.style.display !== 'none') {
                if (!groupInput.value || !groupInput.value.trim()) {
                    alert('è«‹è¼¸å…¥å°çµ„åç¨±');
                    groupInput.focus();
                    return;
                }
                groupName = groupInput.value.trim();
            } else {
                alert('è«‹é¸æ“‡æˆ–è¼¸å…¥å°çµ„');
                return;
            }
            
            if (!name || !name.trim()) {
                alert('è«‹è¼¸å…¥æ‚¨çš„åå­—');
                document.getElementById('userName').focus();
                return;
            }
            
            fetch('/api/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    activity_id: activityId,
                    name: name,
                    group_name: groupName || ''
                })
            })
            .then(res => res.json())
            .then(data => {
                userId = data.id;
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('waitingScreen').classList.add('active');
                socket.emit('join_activity', { activity_id: activityId });
            })
            .catch(err => {
                alert('åŠ å…¥æ´»å‹•å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ´»å‹• ID');
                console.error(err);
            });
        }
        
        // ç›£è½æ´»å‹•ç‹€æ…‹æ›´æ–°
        socket.on('activity_updated', (data) => {
            if (data.activity_id === activityId) {
                if (data.updates.status === 'active') {
                    // å–å¾—ç•¶å‰é¡Œç›®
                    fetch(`/api/activities/${activityId}`)
                        .then(res => res.json())
                        .then(activity => {
                            if (activity.current_question_id) {
                                fetch(`/api/questions`)
                                    .then(res => res.json())
                                    .then(questions => {
                                        currentQuestion = questions.find(q => q.id === activity.current_question_id);
                                        startAnswering();
                                    });
                            }
                        });
                } else if (data.updates.status === 'ended') {
                    // æ¶ç­”çµæŸ
                    showEndedScreen();
                    // æ¸…é™¤é–ƒçˆæ•ˆæœ
                    document.body.classList.remove('flash-red');
                }
            }
        });
        
        // ç›£è½è¨ˆæ™‚å™¨æ›´æ–°ï¼ˆå¾ç®¡ç†é é¢åŒæ­¥ï¼‰
        let lastTimeRemaining = null;
        socket.on('timer_update', (data) => {
            if (data.activity_id === activityId) {
                lastTimeRemaining = timeRemaining;
                timeRemaining = data.time_remaining;
                updateBackgroundFlash();
                
                // å¦‚æœæ™‚é–“å¾1è®Šç‚º0ï¼Œè‡ªå‹•æäº¤ç•¶å‰è¼¸å…¥çš„ç­”æ¡ˆ
                if (lastTimeRemaining === 1 && timeRemaining === 0) {
                    autoSubmitAnswer();
                }
            }
        });
        
        function startAnswering() {
            // éš±è—æ‰€æœ‰ç•«é¢
            document.getElementById('waitingScreen').classList.remove('active');
            document.getElementById('endedScreen').classList.remove('active');
            // é¡¯ç¤ºå›ç­”ç•«é¢
            document.getElementById('answerScreen').classList.add('active');
            document.getElementById('questionContent').textContent = currentQuestion.content;
            document.getElementById('answerText').value = '';
            document.getElementById('successMsg').classList.remove('show');
            
            // æª¢æŸ¥å›ç­”æ¬¡æ•¸é™åˆ¶
            if (currentQuestion.answer_limit) {
                remainingAnswers = currentQuestion.answer_limit;
                // æª¢æŸ¥å·²ç¶“å›ç­”çš„æ¬¡æ•¸
                fetch(`/api/answers?question_id=${currentQuestion.id}&user_id=${userId}`)
                    .then(res => res.json())
                    .then(answers => {
                        const answeredCount = answers.length || 0;
                        remainingAnswers = Math.max(0, currentQuestion.answer_limit - answeredCount);
                        updateSubmitButton();
                    })
                    .catch(err => {
                        console.error('æª¢æŸ¥å›ç­”æ¬¡æ•¸å¤±æ•—:', err);
                        remainingAnswers = currentQuestion.answer_limit;
                        updateSubmitButton();
                    });
            } else {
                remainingAnswers = null; // ç„¡é™åˆ¶
                updateSubmitButton();
            }
        }
        
        function updateSubmitButton() {
            const btn = document.getElementById('submitBtn');
            if (remainingAnswers === null) {
                // ç„¡é™åˆ¶
                btn.disabled = false;
                btn.textContent = 'é€å‡ºç­”æ¡ˆ';
            } else if (remainingAnswers > 0) {
                // é‚„æœ‰å‰©ä½™æ¬¡æ•¸
                btn.disabled = false;
                btn.textContent = `é€å‡ºç­”æ¡ˆï¼ˆé‚„å¯å›ç­” ${remainingAnswers} æ¬¡ï¼‰`;
            } else {
                // å·²é”é™åˆ¶
                btn.disabled = true;
                btn.textContent = 'å·²é”å›ç­”æ¬¡æ•¸é™åˆ¶';
            }
        }
        
        function showEndedScreen() {
            // éš±è—å…¶ä»–ç•«é¢
            document.getElementById('waitingScreen').classList.remove('active');
            document.getElementById('answerScreen').classList.remove('active');
            
            // é¡¯ç¤ºçµæŸç•«é¢
            document.getElementById('endedScreen').classList.add('active');
            
            // æª¢æŸ¥æ´»å‹•ç‹€æ…‹ï¼Œç¢ºèªæ˜¯å¦çœŸçš„çµæŸ
            fetch(`/api/activities/${activityId}`)
                .then(res => res.json())
                .then(activity => {
                    const finalStatus = document.getElementById('finalStatus');
                    if (activity.status === 'ended') {
                        finalStatus.innerHTML = `
                            <p style="color: #555; font-size: 18px; margin-bottom: 10px;">âœ“ æ¶ç­”å·²çµæŸ</p>
                            <p style="color: #999; font-size: 14px;">è«‹ç­‰å¾…ä¸‹ä¸€é¡Œæˆ–æ´»å‹•çµæŸ</p>
                        `;
                    } else if (activity.status === 'active') {
                        // å¦‚æœæ´»å‹•ä»ç„¶é€²è¡Œä¸­ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰æ–°é¡Œç›®
                        if (activity.current_question_id) {
                            // æœ‰æ–°é¡Œç›®ï¼Œé‡æ–°é–‹å§‹å›ç­”
                            fetch(`/api/questions`)
                                .then(res => res.json())
                                .then(questions => {
                                    currentQuestion = questions.find(q => q.id === activity.current_question_id);
                                    startAnswering();
                                });
                        }
                    }
                });
        }
        
        // è‡ªå‹•æäº¤ç­”æ¡ˆï¼ˆæ™‚é–“åˆ°æ™‚ï¼‰
        function autoSubmitAnswer() {
            const answerText = document.getElementById('answerText').value;
            
            // å¦‚æœæœ‰è¼¸å…¥å…§å®¹ï¼Œè‡ªå‹•æäº¤ä¸¦æ¨™è¨˜ç‚ºè‡ªå‹•æäº¤
            if (answerText.trim()) {
                fetch('/api/answers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        activity_id: activityId,
                        question_id: currentQuestion.id,
                        user_id: userId,
                        answer_text: answerText,
                        auto_submitted: true
                    })
                })
                .then(res => {
                    if (res.ok) {
                        console.log('ç­”æ¡ˆå·²è‡ªå‹•æäº¤ï¼ˆæ™‚é–“åˆ°ï¼‰');
                        // æ¸…ç©ºè¼¸å…¥æ¡†
                        document.getElementById('answerText').value = '';
                        // ç¦ç”¨æäº¤æŒ‰éˆ•
                        document.getElementById('submitBtn').disabled = true;
                        document.getElementById('submitBtn').textContent = 'æ™‚é–“å·²åˆ°ï¼ˆå·²è‡ªå‹•æäº¤ï¼‰';
                    }
                })
                .catch(err => {
                    console.error('è‡ªå‹•æäº¤ç­”æ¡ˆå¤±æ•—:', err);
                });
            }
        }
        
        function submitAnswer() {
            const answerText = document.getElementById('answerText').value;
            if (!answerText.trim()) {
                alert('è«‹è¼¸å…¥ç­”æ¡ˆ');
                return;
            }
            
            fetch('/api/answers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    activity_id: activityId,
                    question_id: currentQuestion.id,
                    user_id: userId,
                    answer_text: answerText,
                    auto_submitted: false
                })
            })
            .then(res => {
                if (!res.ok) {
                    return res.json().then(data => {
                        throw new Error(data.error || 'é€å‡ºç­”æ¡ˆå¤±æ•—');
                    });
                }
                return res.json();
            })
            .then(data => {
                // æ›´æ–°å‰©ä½™å›ç­”æ¬¡æ•¸
                if (remainingAnswers !== null) {
                    remainingAnswers--;
                }
                updateSubmitButton();
                document.getElementById('successMsg').classList.add('show');
                
                // å¦‚æœé‚„æœ‰å‰©ä½™æ¬¡æ•¸ï¼Œæ¸…ç©ºè¼¸å…¥æ¡†å…è¨±å†æ¬¡å›ç­”
                if (remainingAnswers === null || remainingAnswers > 0) {
                    document.getElementById('answerText').value = '';
                } else {
                    // å·²é”é™åˆ¶ï¼Œç¦ç”¨æŒ‰éˆ•
                    document.getElementById('submitBtn').disabled = true;
                }
            })
            .catch(err => {
                alert(err.message || 'é€å‡ºç­”æ¡ˆå¤±æ•—');
                console.error(err);
            });
        }
        
        // æ›´æ–°èƒŒæ™¯é–ƒçˆæ•ˆæœï¼ˆæœ€å¾Œ5ç§’ï¼‰
        function updateBackgroundFlash() {
            const body = document.body;
            if (timeRemaining > 0 && timeRemaining <= 5) {
                // è¨ˆç®—ç´…è‰²æ·±åº¦ï¼š5ç§’æœ€æ·ºï¼Œ1ç§’æœ€æ·±
                const intensity = 6 - timeRemaining; // 1åˆ°5
                const redValue = Math.min(255, 100 + (intensity * 7)); // 100åˆ°135ï¼ˆèˆ‡display.htmlä¸€è‡´ï¼‰
                
                // è¨ˆç®—æ¼¸å±¤é¡è‰²ï¼ˆå¾æ·ºç´…åˆ°æ·±ç´…ï¼‰
                const flashColorStart = `rgb(${redValue}, 20, 20)`;
                const flashColorEnd = `rgb(${Math.min(255, redValue + 30)}, 20, 30)`;
                
                // ç§»é™¤ä¹‹å‰çš„å‹•ç•«é¡
                body.classList.remove('flash-red');
                
                // è¨­ç½®é–ƒçˆé¡è‰²
                document.documentElement.style.setProperty('--flash-color-start', flashColorStart);
                document.documentElement.style.setProperty('--flash-color-end', flashColorEnd);
                
                // è§¸ç™¼å‹•ç•«ï¼ˆä½¿ç”¨ setTimeout ç¢ºä¿å‹•ç•«å¯ä»¥é‡è¤‡è§¸ç™¼ï¼‰
                setTimeout(() => {
                    body.classList.add('flash-red');
                }, 10);
            } else if (timeRemaining > 5 || timeRemaining <= 0) {
                // è¶…é5ç§’æˆ–æ™‚é–“åˆ°æ™‚ï¼Œç§»é™¤é–ƒçˆæ•ˆæœ
                body.classList.remove('flash-red');
            }
        }
    </script>
</body>
</html>

